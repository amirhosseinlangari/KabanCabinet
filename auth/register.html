<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f1c68e">
    <title>ثبت نام | کابینت کابان</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/auth.css">
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>ثبت نام در کابینت کابان</h1>
                <p class="auth-subtitle">به خانواده بزرگ ما بپیوندید</p>
            </div>
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <label for="fullName">
                        <i class="fas fa-id-card"></i>
                        نام و نام خانوادگی
                    </label>
                    <input type="text" id="fullName" name="fullName" placeholder="نام و نام خانوادگی خود را وارد کنید">
                    <div class="error-message" id="fullNameError"></div>
                </div>
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        ایمیل
                    </label>
                    <input type="email" id="email" name="email" placeholder="ایمیل خود را وارد کنید">
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label for="phone">
                        <i class="fas fa-phone"></i>
                        شماره موبایل
                    </label>
                    <input type="tel" id="phone" name="phone" placeholder="شماره موبایل خود را وارد کنید">
                    <div class="error-message" id="phoneError"></div>
                </div>
                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        رمز عبور
                    </label>
                    <input type="password" id="password" name="password" minlength="6" placeholder="رمز عبور خود را وارد کنید">
                    <div class="error-message" id="passwordError"></div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">
                        <i class="fas fa-lock"></i>
                        تکرار رمز عبور
                    </label>
                    <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" placeholder="رمز عبور خود را مجدداً وارد کنید">
                    <div class="error-message" id="confirmPasswordError"></div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    ثبت نام
                </button>
                <div class="auth-links">
                    <a href="login.html">
                        <i class="fas fa-sign-in-alt"></i>
                        قبلاً ثبت نام کرده‌اید؟ وارد شوید
                    </a>
                    <a href="../index.html">
                        <i class="fas fa-home"></i>
                        بازگشت به صفحه اصلی
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Load auth.js first -->
    <script src="../scripts/auth.js"></script>
    
    <!-- Then add our registration handling code -->
    <script>
        // Wait for AuthManager to be available
        window.addEventListener('load', () => {
            if (typeof AuthManager === 'undefined') {
                console.error('AuthManager not loaded');
                alert('خطا در بارگذاری سیستم احراز هویت. لطفاً صفحه را رفرش کنید.');
                return;
            }

            // Function to show error messages
            function showError(field, message) {
                const errorElement = document.getElementById(`${field}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }

            // Function to clear all error messages
            function clearErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                    el.style.display = 'none';
                });
            }

            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Form submitted');

                // Clear previous error messages
                clearErrors();

                try {
                    // Get form values
                    const fullName = document.getElementById('fullName').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    let hasError = false;

                    // Validate all fields are filled
                    if (!fullName) {
                        showError('fullName', 'لطفاً نام و نام خانوادگی را وارد کنید');
                        hasError = true;
                    }
                    if (!email) {
                        showError('email', 'لطفاً ایمیل را وارد کنید');
                        hasError = true;
                    }
                    if (!phone) {
                        showError('phone', 'لطفاً شماره موبایل را وارد کنید');
                        hasError = true;
                    }
                    if (!password) {
                        showError('password', 'لطفاً رمز عبور را وارد کنید');
                        hasError = true;
                    }
                    if (!confirmPassword) {
                        showError('confirmPassword', 'لطفاً تکرار رمز عبور را وارد کنید');
                        hasError = true;
                    }

                    if (hasError) return;

                    // Validate password match
                    if (password !== confirmPassword) {
                        showError('confirmPassword', 'رمز عبور و تکرار آن مطابقت ندارند');
                        return;
                    }

                    // Validate password length
                    if (password.length < 6) {
                        showError('password', 'رمز عبور باید حداقل ۶ کاراکتر باشد');
                        return;
                    }

                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showError('email', 'لطفاً یک ایمیل معتبر وارد کنید');
                        return;
                    }

                    // Validate phone number format (Iranian mobile)
                    const phoneRegex = /^09[0-9]{9}$/;
                    if (!phoneRegex.test(phone)) {
                        showError('phone', 'لطفاً یک شماره موبایل معتبر وارد کنید');
                        return;
                    }

                    const formData = {
                        fullName,
                        email,
                        phone,
                        password,
                        cartItems: JSON.parse(localStorage.getItem('cartItems')) || []
                    };

                    // Format cart items to match server expectations
                    if (formData.cartItems.length > 0) {
                        formData.cartItems = formData.cartItems.map(item => ({
                            productId: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: item.quantity,
                            image: item.image || ''
                        }));
                    }

                    console.log('Form data before submission:', formData);

                    const authManager = new AuthManager();
                    const response = await authManager.register(formData);
                    
                    if (response.success) {
                        alert('ثبت نام با موفقیت انجام شد');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    if (error.message) {
                        showError('general', error.message);
                    } else {
                        showError('general', 'خطا در ثبت نام. لطفاً دوباره تلاش کنید.');
                    }
                }
            });
        });
    </script>
</body>
</html> 